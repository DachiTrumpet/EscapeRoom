<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Classe Perduta del '900 - Escape Room Pedagogica</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif; /* Nuovo font per il corpo */
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 0;
            background-image: url('https://images.unsplash.com/photo-1588072432836-e10032774350?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center; /* Centra l'immagine di sfondo */
        }
        
        .container {
            max-width: 1200px; /* Aumentato il max-width per ospitare meglio 3 colonne */
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 40px 20px; /* Aumentato il padding per più spazio */
            border-radius: 10px;
            margin-bottom: 40px; /* Maggiore margine inferiore */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4); /* Ombra più pronunciata */
        }
        
        h1 {
            font-family: 'Playfair Display', serif; /* Nuovo font per il titolo */
            font-size: 3.5em; /* Dimensione maggiore */
            margin-bottom: 15px; /* Spazio sotto il titolo */
            text-shadow: 2px 2px 5px #000;
            letter-spacing: 1px; /* Spaziatura tra le lettere */
        }
        
        .intro-text {
            font-size: 1.2em;
            line-height: 1.7;
            max-width: 800px; /* Limita la larghezza per migliore leggibilità */
            margin: 0 auto 20px auto; /* Centra il testo introduttivo */
            opacity: 0.95; /* Leggera opacità per fondersi meglio */
        }
        
        .room-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* Centra le stanze per migliore simmetria */
            gap: 30px; /* Maggiore spazio tra le stanze */
        }
        
        .room {
            width: calc(33% - 60px); /* 3 stanze per riga, tenendo conto di padding e gap */
            max-width: 350px; /* Larghezza massima per ogni stanza */
            background-color: rgba(255, 255, 255, 0.95); /* Leggera opacità aumentata */
            border-radius: 12px; /* Angoli più arrotondati */
            padding: 30px; /* Padding maggiore all'interno della stanza */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); /* Ombra più definita */
            transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease; /* Transizione smooth */
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-align: center; /* Centra il contenuto all'interno delle stanze */
            border: 2px solid transparent; /* Bordo trasparente di default */
        }
        
        .room:hover {
            transform: translateY(-12px); /* Spostamento leggermente maggiore */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4); /* Ombra più profonda */
            border: 2px solid #3498db; /* Bordo colorato all'hover */
        }
        
        .room h2 {
            font-family: 'Playfair Display', serif; /* Font per i titoli delle stanze */
            font-size: 2em; /* Dimensione maggiore */
            color: #2c3e50;
            border-bottom: 3px solid #3498db; /* Bordo più spesso */
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 20px; /* Spazio sotto il titolo */
        }
        
        .room p {
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .room-icon {
            font-size: 4.5em; /* Icone più grandi */
            text-align: center;
            margin: 20px 0 30px 0; /* Spazio sopra e sotto l'icona */
            color: #3498db;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Sfondo modale più scuro */
            overflow: auto;
            backdrop-filter: blur(5px); /* Effetto sfocatura sullo sfondo */
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 3% auto; /* Modificato margine per centrare meglio */
            padding: 40px; /* Padding maggiore */
            border-radius: 12px;
            width: 90%; /* Larghezza modale aumentata per schermi più piccoli */
            max-width: 850px; /* Larghezza massima per le modali */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6); /* Ombra più definita */
            position: relative;
            animation: modalopen 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Animazione con effetto bounce */
        }
        
        @keyframes modalopen {
            from {opacity: 0; transform: scale(0.9) translateY(-100px);}
            to {opacity: 1; transform: scale(1) translateY(0);}
        }
        
        .close {
            color: #777; /* Colore più soft per la X */
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 32px; /* Dimensione maggiore */
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #333;
        }
        
        /* Stili per elementi di gioco all'interno delle modali */
        .puzzle-container, .memory-game, .cloze-text, .symbol-code, .quiz-container {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            margin: 25px 0;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); /* Ombra interna */
        }
        
        .puzzle-container {
            display: flex;
            justify-content: center; /* Centra i pezzi del puzzle */
            flex-wrap: wrap;
        }

        .puzzle-piece {
            width: 110px;
            height: 110px;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px;
            border-radius: 8px;
            cursor: grab; /* Cursore per drag */
            font-size: 2.2em;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .puzzle-piece:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .puzzle-target {
            width: 110px;
            height: 110px;
            border: 3px dashed #2c3e50;
            background-color: #eee; /* Colore di sfondo per target */
            margin: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column; /* Per allineare testo e icona */
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 1em;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        .puzzle-target span {
            margin-top: 5px;
            font-weight: bold;
        }

        .memory-game {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px; /* Maggiore gap */
            margin: 25px auto;
            max-width: 550px; /* Larghezza maggiore */
        }
        
        .memory-card {
            height: 120px; /* Altezza maggiore */
            background-color: #2c3e50;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5em;
            cursor: pointer;
            transition: transform 0.4s ease, background-color 0.4s ease;
            transform-style: preserve-3d;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        
        .memory-card.flipped {
            transform: rotateY(180deg);
            background-color: #3498db;
            color: white; /* Assicura che il testo sia visibile dopo flip */
        }
        
        /* New styles for Herbart puzzle */
        .cloze-puzzle-container {
            display: flex;
            flex-wrap: wrap; /* Allows stacking on smaller screens */
            gap: 20px;
            margin-top: 20px;
            justify-content: center; /* Center the puzzle parts */
        }

        .cloze-text {
            flex: 2; /* Takes more space */
            min-width: 400px; /* Minimum width for the text */
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            line-height: 2.5;
        }

        .herbart-word-options {
            flex: 1; /* Takes less space */
            min-width: 200px; /* Minimum width for options */
            background-color: #eef; /* Light blue background */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .herbart-word-options h3 {
            color: #3498db;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .herbart-options-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .herbart-option {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: grab;
            transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        .herbart-option:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .herbart-option:active {
            cursor: grabbing;
            transform: translateY(0);
            box-shadow: none;
        }

        /* Specific styling for the cloze gaps as drop targets */
        .cloze-gap {
            border-bottom: 2px dashed #555;
            padding: 0 8px;
            min-width: 100px;
            display: inline-block;
            text-align: center;
            position: relative;
            cursor: default; /* Not clickable like before, now a drop target */
            transition: background-color 0.3s, border-color 0.3s;
            vertical-align: middle; /* Align with text */
            color: inherit; /* Reset color for unfilled state */
            font-weight: normal; /* Reset font-weight for unfilled state */
        }

        .cloze-gap.highlight-drop {
            border-color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
        }

        .cloze-gap.correct-fill {
            background-color: #e6ffe6;
            color: #2ecc71;
            font-weight: bold;
            border-color: #2ecc71;
        }
        
        .symbol-code {
            font-size: 1.3em;
            line-height: 1.8;
        }
        
        .symbol {
            color: #e74c3c; /* Initial color for the placeholder */
            font-weight: bold;
            cursor: pointer; /* Still clickable, but no drag. User clicks word in table to fill this. */
            border-bottom: 2px dashed #e74c3c; /* Bordo più visibile */
            transition: color 0.3s, border-bottom 0.3s;
            min-width: 80px; /* Ensure space for the word */
            display: inline-block;
            text-align: center;
        }
        .symbol:hover {
            color: #c0392b;
        }
        
        .symbol-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Rende la tabella responsiva */
            gap: 15px; /* Maggiore gap */
            margin: 25px 0;
        }
        
        .symbol-item {
            padding: 15px; /* Padding maggiore */
            background-color: #3498db;
            color: white;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 1.1em; /* Adjusted font size for words */
            transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease; /* Added opacity for fading out */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; /* For alignment of content */
            align-items: center;
            justify-content: center;
        }
        
        .symbol-item:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }

        .symbol-item.used { /* Style for used words */
            opacity: 0.5;
            cursor: default;
            background-color: #999;
            pointer-events: none; /* Disable clicks */
        }
        
        .quiz-question {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .quiz-options label {
            display: block; /* Ogni opzione su nuova riga */
            margin: 10px 0;
            cursor: pointer;
            font-size: 1.1em;
        }
        .quiz-options label:hover {
            color: #3498db;
        }
        
        .success-message {
            background-color: #2ecc71;
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin: 25px 0;
            display: none;
            animation: fadeIn 0.6s ease-out;
            font-size: 1.2em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(20px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .success-message button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 15px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        
        .success-message button:hover {
            background-color: #229954;
            transform: translateY(-2px);
        }
        
        .final-message {
            text-align: center;
            margin-top: 50px; /* Maggiore margine */
            padding: 30px;
            background-color: rgba(46, 204, 113, 0.9); /* Opacità maggiore */
            color: white;
            border-radius: 12px;
            display: none;
            font-size: 1.3em;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .final-message h2 {
            font-family: 'Playfair Display', serif;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 18px; /* Padding aumentato */
            border-radius: 8px; /* Angoli più arrotondati */
            font-size: 1.4em; /* Testo più grande */
            font-family: 'monospace';
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10; /* Assicura che sia sopra tutto */
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0; /* Colore più chiaro */
            border-radius: 8px;
            margin: 30px 0; /* Spazio maggiore */
            overflow: hidden; /* Per contenere la barra */
        }
        
        .progress-bar {
            height: 30px; /* Altezza maggiore */
            background-color: #3498db;
            border-radius: 8px;
            width: 0%;
            transition: width 0.6s ease-out, background-color 0.6s ease-out; /* Transizione smooth */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .completed {
            background-color: #2ecc71 !important; /* Colore di completamento */
        }
        
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 15px; /* Padding maggiore */
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em; /* Dimensione maggiore */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 10;
        }

        .sound-toggle:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .room {
                width: calc(50% - 50px); /* 2 stanze per riga */
            }
            h1 {
                font-size: 3em;
            }
        }

        @media (max-width: 768px) {
            .room {
                width: calc(100% - 40px); /* 1 stanza per riga */
                max-width: 400px; /* Limite per evitare stanze troppo larghe */
            }
            h1 {
                font-size: 2.5em;
            }
            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 25px;
            }
            .memory-game {
                grid-template-columns: repeat(2, 1fr); /* 2 colonne per memory game */
                max-width: 300px;
            }
            .symbol-table {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Simboli più piccoli */
            }
            .symbol-item {
                font-size: 0.9em; /* Adjusted font size for words */
            }
            .cloze-puzzle-container {
                flex-direction: column;
            }
            .cloze-text, .herbart-word-options {
                min-width: unset; /* Remove min-width to allow full flexibility */
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 2em;
            }
            .intro-text {
                font-size: 1em;
            }
            .timer, .sound-toggle {
                font-size: 1.1em;
                padding: 10px 12px;
            }
            .room-icon {
                font-size: 3.5em;
            }
            .puzzle-piece, .puzzle-target {
                width: 90px;
                height: 90px;
                font-size: 1.8em;
            }
            .cloze-gap {
                min-width: 80px;
                font-size: 0.9em;
            }
            .symbol-code {
                font-size: 1.1em;
            }
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="timer" id="timer">60:00</div>
    <button class="sound-toggle" id="soundToggle">🔊</button>
    
    <div class="container">
        <header>
            <h1>La Classe Perduta del '900</h1>
            <div class="intro-text">
                <p>Una misteriosa lettera è stata ritrovata nella biblioteca scolastica. Cinque grandi pedagogisti hanno lasciato indizi nascosti per salvare la scuola da una minaccia: la totale dimenticanza dei valori educativi.</p>
                <p>Risolvi gli enigmi in ogni stanza per "riattivare" l'educazione nella scuola!</p>
                <p><strong>Tempo rimanente: 60 minuti</strong></p>
            </div>
        </header>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="room-container">
            <!-- Stanza 1: Pestalozzi -->
            <div class="room" id="room1">
                <div class="room-icon">📦</div>
                <h2>Il cuore, la testa e la mano</h2>
                <p><strong>Johann Heinrich Pestalozzi</strong></p>
                <p>Ricostruisci il triangolo educativo pestalozziano abbinando le figure alle parole chiave.</p>
            </div>
            
            <!-- Stanza 2: Fröbel -->
            <div class="room" id="room2">
                <div class="room-icon">🧸</div>
                <h2>Il Giardino dei Bambini</h2>
                <p><strong>Friedrich Fröbel</strong></p>
                <p>Trova le coppie nel memory per scoprire il messaggio nascosto sul valore del gioco.</p>
            </div>
            
            <!-- Stanza 3: Herbart -->
            <div class="room" id="room3">
                <div class="room-icon">🎓</div>
                <h2>L'istruzione come formazione morale</h2>
                <p><strong>Johann Friedrich Herbart</strong></p>
                <p>Completa il testo con le parole mancanti trascinandole e scopri la parola segreta.</p>
            </div>
            
            <!-- Stanza 4: Lambruschini -->
            <div class="room" id="room4">
                <div class="room-icon">🕊️</div>
                <h2>L'educazione cristiana e affettiva</h2>
                <p><strong>Raffaello Lambruschini</strong></p>
                <p>Decifra la lettera usando la tabella dei valori per scoprire il messaggio sull'amore educativo.</p>
            </div>
            
            <!-- Stanza 5: Gabelli -->
            <div class="room" id="room5">
                <div class="room-icon">📚</div>
                <h2>Il maestro come guida laica</h2>
                <p><strong>Aristide Gabelli</strong></p>
                <p>Rispondi correttamente al quiz sui concetti di scuola laica, merito e cittadinanza attiva.</p>
            </div>
        </div>
        
        <div class="final-message" id="finalMessage">
            <h2>Congratulazioni!</h2>
            <p>Hai completato tutte le stanze e riattivato i valori educativi nella scuola!</p>
            <p>Grazie al tuo impegno, l'educazione è salva dall'oblio.</p>
        </div>
    </div>
    
    <!-- Modali per ogni stanza -->
    
    <!-- Stanza 1: Pestalozzi -->
    <div id="modal1" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal1')">&times;</span>
            <h2>Il cuore, la testa e la mano - Pestalozzi</h2>
            <p>Johann Heinrich Pestalozzi credeva in un'educazione che sviluppasse l'essere umano nella sua interezza. Abbinate le figure ai concetti che esse rappresentano nella sua visione pedagogica.</p>
            
            <p>Abbina ogni figura alle parole chiave corrette:</p>
            
            <div class="puzzle-container" id="pestalozzi-pieces-container">
                <!-- Puzzle pieces will be dynamically generated here -->
            </div>
            
            <div class="puzzle-container" id="pestalozzi-targets-container">
                <div class="puzzle-target" data-target="morale">Educazione <span id="target-morale">______</span></div>
                <div class="puzzle-target" data-target="intellettuale">Educazione <span id="target-intellettuale">______</span></div>
                <div class="puzzle-target" data-target="pratica">Educazione <span id="target-pratica">______</span></div>
            </div>
            
            <div class="success-message" id="success1">
                <p>Ottimo! Hai ricostruito correttamente il triangolo educativo di Pestalozzi:</p>
                <p><strong>Cuore (educazione morale) - Testa (educazione intellettuale) - Mano (educazione pratica)</strong></p>
                <button onclick="completeRoom(1)">Continua</button>
            </div>
        </div>
    </div>
    
    <!-- Stanza 2: Fröbel -->
    <div id="modal2" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal2')">&times;</span>
            <h2>Il Giardino dei Bambini - Fröbel</h2>
            <p>Friedrich Fröbel, creatore dei Kindergarten (giardini d'infanzia), considerava il gioco come strumento fondamentale per l'apprendimento.</p>
            <p>Trova tutte le coppie nel memory per scoprire il messaggio nascosto:</p>
            
            <div class="memory-game" id="memoryGame">
                <!-- Le carte verranno generate dinamicamente con JavaScript -->
            </div>
            
            <div class="success-message" id="success2">
                <p>Esatto! Il messaggio di Fröbel è:</p>
                <p><strong>"Il gioco è il lavoro del bambino."</strong></p>
                <button onclick="completeRoom(2)">Continua</button>
            </div>
        </div>
    </div>
    
    <!-- Stanza 3: Herbart -->
    <div id="modal3" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal3')">&times;</span>
            <h2>L'istruzione come formazione morale - Herbart</h2>
            <p>Johann Friedrich Herbart sosteneva che l'istruzione fosse fondamentale per la formazione morale del carattere. Completa il testo trascinando le parole corrette.</p>
            <p>Ogni spazio corretto rivelerà una lettera speciale che ti aiuterà a formare una parola segreta.</p>

            <div class="cloze-puzzle-container">
                <div class="cloze-text">
                    <p>Secondo Herbart, l'istruzione deve formare il carattere attraverso lo sviluppo degli <span class="cloze-gap" data-correct="interessi" data-hidden-letter="A" data-gap-id="1">______</span>. 
                    Le nuove conoscenze devono essere presentate in modo chiaro attraverso adeguate <span class="cloze-gap" data-correct="rappresentazioni" data-hidden-letter="L" data-gap-id="2">______</span> 
                    e collegate a quelle già possedute tramite il processo dell'<span class="cloze-gap" data-correct="appercezione" data-hidden-letter="M" data-gap-id="3">______</span>. 
                    Solo così l'educazione può avere una solida base <span class="cloze-gap" data-correct="morale" data-hidden-letter="A" data-gap-id="4">______</span>.</p>
                </div>
                
                <div class="herbart-word-options">
                    <h3>Trascina le parole:</h3>
                    <div class="herbart-options-list">
                        <!-- Words will be generated here by JS -->
                    </div>
                </div>
            </div>

            <div id="herbartSecretWordDisplay" style="text-align: center; margin-top: 30px; font-size: 2.5em; letter-spacing: 12px; font-weight: bold; color: #2c3e50; font-family: 'Playfair Display', serif;">
                _ _ _ _
            </div>
            
            <div class="success-message" id="success3">
                <p>Perfetto! Hai compreso i concetti chiave di Herbart:</p>
                <p><strong>L'istruzione guidata sviluppa interesse, organizza rappresentazioni chiare e favorisce l'appercezione, formando così il carattere morale.</strong></p>
                <button onclick="completeRoom(3)">Continua</button>
            </div>
        </div>
    </div>
    
    <!-- Stanza 4: Lambruschini -->
    <div id="modal4" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal4')">&times;</span>
            <h2>L'educazione cristiana e affettiva - Lambruschini</h2>
            <p>Raffaello Lambruschini sosteneva un'educazione basata sui valori cristiani e sull'amore educativo.</p>
            <p>Decifra la lettera usando la tabella dei valori. Clicca sulle parole della tabella per inserirle al posto dei simboli nel testo:</p>
            
            <div class="symbol-code">
                <p>Caro bambino,</p>
                <p>L'educazione è prima di tutto un atto d'<span class="symbol" data-value="amore">______</span>. 
                Il maestro deve <span class="symbol" data-value="ascoltare">______</span> con attenzione i bisogni dell'allievo, 
                rispettando la sua <span class="symbol" data-value="coscienza">______</span> e aiutandolo a sviluppare una solida 
                <span class="symbol" data-value="moralità">______</span>. Ricorda che ogni persona è unica e va amata per quello che è.</p>
                <p>Con affetto,<br>Il tuo educatore</p>
            </div>
            
            <div class="symbol-table">
                <!-- Mostra solo la parola, senza simboli -->
                <div class="symbol-item" data-word="amore">amore</div>
                <div class="symbol-item" data-word="ascoltare">ascoltare</div>
                <div class="symbol-item" data-word="coscienza">coscienza</div>
                <div class="symbol-item" data-word="moralità">moralità</div>
                <div class="symbol-item" data-word="rispetto">rispetto</div>
                <div class="symbol-item" data-word="carità">carità</div>
            </div>
            
            <div class="success-message" id="success4">
                <p>Bravo! Il messaggio decifrato rivela:</p>
                <p><strong>"L'educazione è prima di tutto un atto d'amore. Il maestro deve ascoltare con attenzione i bisogni dell'allievo, rispettando la sua coscienza e aiutandolo a sviluppare una solida moralità."</strong></p>
                <button onclick="completeRoom(4)">Continua</button>
            </div>
        </div>
    </div>
    
    <!-- Stanza 5: Gabelli -->
    <div id="modal5" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modal5')">&times;</span>
            <h2>Il maestro come guida laica - Gabelli</h2>
            <p>Aristide Gabelli promuoveva una scuola laica basata sul merito e sulla cittadinanza attiva.</p>
            <p>Rispondi alle domande per sbloccare la parola finale:</p>
            
            <div class="quiz-container">
                <div class="quiz-question">
                    <p>1. Gabelli sosteneva che la scuola dovesse essere:</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q1" value="a"> A) Confessionale e religiosa</label><br>
                        <label><input type="radio" name="q1" value="b" data-correct> B) Laica e basata sul metodo scientifico</label><br>
                        <label><input type="radio" name="q1" value="c"> C) Elitaria e riservata a pochi</label>
                    </div>
                </div>
                
                <div class="quiz-question">
                    <p>2. Quale tra questi NON era un principio educativo di Gabelli?</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q2" value="a"> A) Osservazione diretta</label><br>
                        <label><input type="radio" name="q2" value="b"> B) Esperienza concreta</label><br>
                        <label><input type="radio" name="q2" value="c" data-correct> C) Memorizzazione nozionistica</label>
                    </div>
                </div>
                
                <div class="quiz-question">
                    <p>3. Gabelli considerava fondamentale insegnare:</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q3" value="a"> A) Solo le materie scientifiche</label><br>
                        <label><input type="radio" name="q3" value="b" data-correct> B) Educazione civica e senso di responsabilità</label><br>
                        <label><input type="radio" name="q3" value="c"> C) Esclusivamente le lingue classiche</label>
                    </div>
                </div>
            </div>
            
            <!-- Corretto il numero di underscore per EDUCAZIONE CIVICA (17 caratteri: 16 lettere + 1 spazio) -->
            <div id="quizLetters" style="text-align: center; margin: 20px 0; font-family: 'Playfair Display', serif; font-size: 2.5em; letter-spacing: 12px; font-weight: bold; color: #2c3e50;">
                _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
            </div>
            
            <div class="success-message" id="success5">
                <p>Eccellente! La parola finale è:</p>
                <p><strong>EDUCAZIONE CIVICA</strong></p>
                <p>Hai completato tutte le stanze!</p>
                <button onclick="completeRoom(5)">Vedi il risultato finale</button>
            </div>
        </div>
    </div>
    
    <audio id="backgroundMusic" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="successSound">
        <source src="https://www.soundjay.com/buttons/sounds/button-09.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="clickSound">
        <source src="https://www.soundjay.com/buttons/sounds/button-10.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        // Variabili globali
        let completedRooms = 0;
        let timeLeft = 3600; // 60 minuti in secondi
        let timerInterval;
        let soundEnabled = true;
        
        // Inizializzazione al caricamento della pagina
        window.onload = function() {
            setupRooms();
            // setupDragAndDrop(); // This is now called inside openModal('modal1')
            setupMemoryGame();
            setupClozeTest(); // This function now handles Herbart's new puzzle
            setupSymbolCode();
            setupQuiz();
            startTimer();
            updateProgressBar();
            
            // Riproduci musica di sottofondo (richiede interazione utente per alcuni browser)
            const bgMusic = document.getElementById('backgroundMusic');
            bgMusic.volume = 0.3;
            if(soundEnabled) {
                // Try to play on load, but allow user interaction to trigger it if autoplay is blocked
                document.body.addEventListener('click', () => {
                    if (bgMusic.paused) {
                        bgMusic.play().catch(f => console.log("Riproduzione musica dopo click bloccata:", f));
                    }
                }, { once: true });
            }
        };
        
        // Configurazione delle stanze
        function setupRooms() {
            document.querySelectorAll('.room').forEach(room => {
                room.addEventListener('click', function() {
                    const roomId = this.id.replace('room', '');
                    if(this.classList.contains('completed')) {
                        playSound('clickSound');
                        alert('Hai già completato questa stanza!');
                        return;
                    }
                    openModal('modal' + roomId);
                    
                    // Special setup for Pestalozzi to randomize on open
                    if (roomId === '1') {
                        setupPestalozziDragAndDrop();
                    }
                    playSound('clickSound');
                });
            });
        }
        
        // Apertura modale
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden'; // Impedisce lo scroll del body
        }
        
        // Chiusura modale
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto'; // Riabilita lo scroll del body
            playSound('clickSound');
        }
        
        // Completamento stanza
        function completeRoom(roomNumber) {
            if(!document.getElementById('room' + roomNumber).classList.contains('completed')) {
                completedRooms++;
                document.getElementById('room' + roomNumber).classList.add('completed');
                updateProgressBar();
                playSound('successSound');
                
                if(completedRooms === 5) {
                    showFinalMessage();
                    clearInterval(timerInterval); // Ferma il timer
                }
            }
            closeModal('modal' + roomNumber);
        }
        
        // Mostra messaggio finale
        function showFinalMessage() {
            document.getElementById('finalMessage').style.display = 'block';
            document.getElementById('finalMessage').scrollIntoView({ behavior: 'smooth' });
            document.body.style.overflow = 'auto'; // Assicurati che lo scroll sia attivo per vedere il messaggio finale
        }
        
        // Timer
        function startTimer() {
            timerInterval = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert('Tempo scaduto! Non sei riuscito a completare tutte le stanze in tempo.');
                    // Potresti voler ricaricare la pagina o mostrare un messaggio di fallimento
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Cambia colore quando rimangono 5 minuti (300 secondi)
            if(timeLeft <= 300) {
                document.getElementById('timer').style.backgroundColor = 'rgba(231, 76, 60, 0.7)';
            }
        }
        
        // Barra di progresso
        function updateProgressBar() {
            const progress = (completedRooms / 5) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = `${completedRooms}/5 Stanze`; // Mostra il progresso testuale
            
            if(completedRooms === 5) {
                progressBar.classList.add('completed');
                progressBar.textContent = 'Missione Completata!';
            }
        }
        
        // Puzzle drag and drop (Stanza 1) - Pestalozzi
        function setupPestalozziDragAndDrop() {
            const piecesContainer = document.getElementById('pestalozzi-pieces-container');
            const targets = document.querySelectorAll('#modal1 .puzzle-target');
            
            // Clear previous pieces and reset targets
            piecesContainer.innerHTML = '';
            targets.forEach(target => {
                target.querySelector('span').textContent = '______';
                target.style.border = '3px dashed #2c3e50';
                target.style.backgroundColor = '#eee';
            });

            const initialPieces = shuffleArray([
                { value: 'cuore', icon: '❤️' },
                { value: 'testa', icon: '🧠' },
                { value: 'mano', icon: '✋' }
            ]);

            initialPieces.forEach(pieceData => {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.draggable = true;
                piece.dataset.value = pieceData.value;
                piece.textContent = pieceData.icon;
                piecesContainer.appendChild(piece);

                piece.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.value);
                    e.dataTransfer.setDragImage(this, 50, 50);
                });
            });
            
            // Attach drop listeners (only once, as targets are static)
            // Ensure they are not duplicated if setupPestalozziDragAndDrop is called multiple times.
            // A simpler way is to check if listeners are already attached, or remove and reattach.
            // For now, let's assume they are only attached once on the targets.
            // If the drop target's background or border needs reset, it's done within the drop event.
            // If the piece is correctly placed, it's removed from the DOM, so no need to manage its dragend.

            // Only attach drop listeners once (e.g., on window.onload or when the game starts)
            // If they are static elements, their listeners can be attached once.
            // For this specific setup, they are already attached in setupDragAndDrop in window.onload.
            // So we just need to ensure the piece generation is correct.
            
            // To ensure listeners are only attached once to targets, move target listener setup
            // out of this function and into general setup (if not already there).
            // Current code does attach them inside a `setupDragAndDrop` which is called once.
            // So, no change needed for targets' listeners here, just pieces.
            // The `if (draggedPiece)` check in drop handles removal.
        }

        // Call the pestalozzi setup initially (for the first time the modal opens)
        // and when the modal is reopened if necessary.
        // It's safer to have openModal('modal1') directly call setupPestalozziDragAndDrop().
        // No need for a global setupDragAndDrop function in window.onload if Pestalozzi is handled separately.
        // Let's remove the global setupDragAndDrop and make sure openModal('modal1') calls setupPestalozziDragAndDrop.
        
        // This is the global one, called once, needs to be changed.
        // So I'll modify the `openModal` logic for `modal1` to call `setupPestalozziDragAndDrop`.
        // The original `setupDragAndDrop` will be renamed `setupPestalozziDragAndDrop` and specialized for that modal.

        // Re-adding the original target setup logic so it's guaranteed to run ONCE globally.
        // This ensures targets always have their drop listeners regardless of how many times Pestalozzi modal opens.
        const pestalozziTargets = document.querySelectorAll('#modal1 .puzzle-target');
        pestalozziTargets.forEach(target => {
            target.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.border = '3px dashed #3498db';
            });
            target.addEventListener('dragleave', function() {
                this.style.border = '3px dashed #2c3e50';
            });
            target.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.border = '3px dashed #2c3e50';
                const data = e.dataTransfer.getData('text/plain');
                const targetSpan = this.querySelector('span');
                
                if (targetSpan.textContent === '______' || targetSpan.textContent === '') {
                    const targetType = this.dataset.target;
                    let correct = false;
                    if(targetType === 'morale' && data === 'cuore') correct = true;
                    if(targetType === 'intellettuale' && data === 'testa') correct = true;
                    if(targetType === 'pratica' && data === 'mano') correct = true;
                    
                    if(correct) {
                        targetSpan.textContent = data;
                        this.style.border = '3px solid #2ecc71';
                        this.style.backgroundColor = '#e6ffe6';
                        
                        // Find and visually remove the dragged piece
                        const draggedPiece = document.querySelector(`#modal1 .puzzle-piece[data-value="${data}"]`);
                        if (draggedPiece) {
                            draggedPiece.parentNode.removeChild(draggedPiece);
                        }
                        playSound('successSound');
                        checkPestalozziPuzzleCompletion(); // Renamed to be specific
                    } else {
                        playSound('clickSound');
                        alert('Abbinamento errato! Riprova.');
                    }
                } else {
                    playSound('clickSound');
                    alert('Questo spazio è già occupato! Riprova.');
                }
            });
        });

        function checkPestalozziPuzzleCompletion() {
            const morale = document.getElementById('target-morale').textContent;
            const intellettuale = document.getElementById('target-intellettuale').textContent;
            const pratica = document.getElementById('target-pratica').textContent;
            
            if(morale === 'cuore' && intellettuale === 'testa' && pratica === 'mano') {
                document.getElementById('success1').style.display = 'block';
            }
        }
        
        // Memory game (Stanza 2)
        function setupMemoryGame() {
            const pairs = [
                {symbol: '△', word: 'Il'}, {symbol: '○', word: 'gioco'}, {symbol: '□', word: 'è'},
                {symbol: '◇', word: 'il'}, {symbol: '☆', word: 'lavoro'}, {symbol: '♡', word: 'del'},
                {symbol: '⚡', word: 'bambino'}, {symbol: '⚛️', word: '.'} 
            ];
            
            // Crea le carte duplicando le coppie e mescolando
            let cardsData = [];
            pairs.forEach(p => {
                cardsData.push({ ...p, id: p.symbol + '1' });
                cardsData.push({ ...p, id: p.symbol + '2' });
            });
            
            shuffleArray(cardsData); // Mescola le carte
            
            const gameContainer = document.getElementById('memoryGame');
            gameContainer.innerHTML = ''; // Pulisci eventuali carte precedenti
            
            let flippedCards = [];
            let matchedPairsCount = 0;
            const totalPairs = pairs.length;
            
            cardsData.forEach((cardData, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.symbol = cardData.symbol;
                card.dataset.word = cardData.word;
                card.dataset.id = cardData.id; // Per tracciare le carte
                
                card.addEventListener('click', function() {
                    if (this.classList.contains('flipped') || flippedCards.length === 2) {
                        return; // Evita di cliccare carte già girate o se due sono già girate
                    }
                    
                    this.classList.add('flipped');
                    this.textContent = this.dataset.symbol; // Mostra il simbolo
                    flippedCards.push(this);
                    playSound('clickSound');
                    
                    if(flippedCards.length === 2) {
                        checkForMatch();
                    }
                });
                
                gameContainer.appendChild(card);
            });
            
            function checkForMatch() {
                const card1 = flippedCards[0];
                const card2 = flippedCards[1];
                
                if(card1.dataset.symbol === card2.dataset.symbol) {
                    matchedPairsCount++;
                    // Remove listeners for matched cards to prevent further clicks
                    card1.removeEventListener('click', arguments.callee);
                    card2.removeEventListener('click', arguments.callee);
                    flippedCards = [];
                    
                    if(matchedPairsCount === totalPairs) {
                        setTimeout(() => {
                            document.getElementById('success2').style.display = 'block';
                            // Visualizza il messaggio finale sul gioco memory
                            const message = "Il gioco è il lavoro del bambino.";
                            let wordIndex = 0;
                            document.querySelectorAll('#modal2 .memory-card').forEach(card => { // Ensure target modal2
                                card.classList.add('flipped');
                                card.textContent = message.split(' ')[wordIndex++];
                                if (wordIndex >= message.split(' ').length) wordIndex = 0; // Ripeti parole se necessario
                            });
                        }, 500);
                    }
                } else {
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        card1.textContent = ''; // Nascondi il simbolo
                        card2.textContent = ''; // Nascondi il simbolo
                        flippedCards = [];
                    }, 1000);
                }
            }
        }
        
        // Cloze test (Stanza 3) - Herbart's New Puzzle
        function setupClozeTest() {
            const gaps = document.querySelectorAll('#modal3 .cloze-gap');
            const herbartOptionsList = document.querySelector('#modal3 .herbart-options-list');
            const secretWordDisplay = document.getElementById('herbartSecretWordDisplay');
            
            const allPossibleWords = shuffleArray(['interessi', 'rappresentazioni', 'appercezione', 'morale', 'emozione', 'cultura']); // 4 correct, 2 distractors
            const secretWord = "ALMA"; // The final secret word
            const revealedSecretLetters = Array(secretWord.length).fill('_');

            // Reset gaps for replayability (if modal closed and reopened)
            gaps.forEach(gap => {
                gap.textContent = '______';
                gap.classList.remove('correct-fill');
                gap.dataset.filled = 'false';
            });
            for(let i = 0; i < revealedSecretLetters.length; i++) revealedSecretLetters[i] = '_';
            secretWordDisplay.textContent = revealedSecretLetters.join(' ');


            // Generate word options for dragging
            herbartOptionsList.innerHTML = allPossibleWords.map(word => 
                `<span class="herbart-option" draggable="true" data-word="${word}">${word}</span>`
            ).join('');

            const draggableWords = document.querySelectorAll('#modal3 .herbart-option');
            let currentDraggedWordElement = null; // To keep track of the element being dragged

            // --- Drag & Drop for words ---
            draggableWords.forEach(word => {
                word.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.word);
                    e.dataTransfer.setDragImage(this, 30, 15);
                    currentDraggedWordElement = this; // Store reference to the actual DOM element
                    setTimeout(() => this.style.opacity = '0.4', 0); // Make it semi-transparent while dragging
                });

                word.addEventListener('dragend', function() {
                    // If the element hasn't been removed (i.e., not dropped correctly), make it fully visible again
                    if (this.parentNode) { // Check if it's still in the DOM
                        this.style.opacity = '1';
                    }
                    currentDraggedWordElement = null;
                });
            });

            gaps.forEach((gap) => {
                gap.addEventListener('dragover', function(e) {
                    e.preventDefault(); // Allow drop
                    if (currentDraggedWordElement && this.dataset.filled !== 'true') { // Only highlight if something is dragged and gap is empty
                        this.classList.add('highlight-drop');
                    }
                });

                gap.addEventListener('dragleave', function() {
                    this.classList.remove('highlight-drop');
                });

                gap.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('highlight-drop');
                    
                    const droppedWord = e.dataTransfer.getData('text/plain');
                    const correctWordForGap = this.dataset.correct;
                    const hiddenLetter = this.dataset.hiddenLetter;
                    const gapId = parseInt(this.dataset.gapId) - 1; // 0-indexed for array

                    if (this.dataset.filled === 'true') { // If gap is already filled
                        playSound('clickSound');
                        alert('Questo spazio è già stato riempito correttamente.');
                        if (currentDraggedWordElement) {
                            currentDraggedWordElement.style.opacity = '1'; // Make draggable word visible again
                        }
                        return;
                    }

                    if (droppedWord === correctWordForGap) {
                        this.textContent = droppedWord;
                        this.classList.add('correct-fill');
                        this.dataset.filled = 'true'; // Mark as correctly filled

                        revealedSecretLetters[gapId] = hiddenLetter; // Place letter in correct position
                        updateHerbartSecretWordDisplay();
                        
                        if (currentDraggedWordElement) {
                            currentDraggedWordElement.parentNode.removeChild(currentDraggedWordElement); // Remove from source list
                        }
                        playSound('successSound');
                        checkClozeCompletion();

                    } else {
                        playSound('clickSound'); // Error sound
                        alert('Parola errata! Riprova.');
                        if (currentDraggedWordElement) {
                            currentDraggedWordElement.style.opacity = '1'; // Make draggable word visible again
                        }
                    }
                });
            });

            function updateHerbartSecretWordDisplay() {
                secretWordDisplay.textContent = revealedSecretLetters.join(' ');
            }

            function checkClozeCompletion() {
                const allGapsFilledCorrectly = Array.from(gaps).every(gap => gap.dataset.filled === 'true');
                if (allGapsFilledCorrectly) {
                    document.getElementById('success3').style.display = 'block';
                }
            }

            // Initialize the secret word display
            updateHerbartSecretWordDisplay();
        }
        
        // Codice simbolico (Stanza 4) - Lambruschini
        function setupSymbolCode() {
            const symbolsInText = document.querySelectorAll('#modal4 .symbol'); // I placeholder nel testo da riempire
            const symbolItems = document.querySelectorAll('#modal4 .symbol-item'); // Gli elementi cliccabili nella tabella delle parole
            
            // Mappa per tenere traccia delle parole correttamente inserite nel testo
            let filledWordsInText = {};
            symbolsInText.forEach(placeholder => filledWordsInText[placeholder.dataset.value] = false); // 'amore', 'ascoltare', etc.

            // Reset placeholders for replayability (if modal closed and reopened)
            symbolsInText.forEach(placeholder => {
                placeholder.textContent = '______'; // Reset to blank
                placeholder.style.color = '#e74c3c'; // Reset color
                placeholder.style.borderBottom = '2px dashed #e74c3c'; // Reset border
            });
            // Reset clickable word items
            symbolItems.forEach(item => {
                item.classList.remove('used'); // Re-enable all words
            });


            symbolItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Check if this word item has already been used
                    if (this.classList.contains('used')) {
                        playSound('clickSound');
                        alert('Questa parola è già stata usata!');
                        return;
                    }

                    const wordToInsert = this.dataset.word; // La parola da inserire (es. 'amore')
                    
                    // Trova il placeholder corrispondente nel testo che dovrebbe contenere questa parola
                    const targetPlaceholder = document.querySelector(`#modal4 .symbol[data-value="${wordToInsert}"]`);
                    
                    if (targetPlaceholder && !filledWordsInText[wordToInsert]) { 
                        // Se il placeholder esiste e non è ancora stato riempito correttamente con QUESTA parola
                        targetPlaceholder.textContent = wordToInsert; // Sostituisce i trattini con la parola
                        targetPlaceholder.style.color = '#2ecc71';
                        targetPlaceholder.style.borderBottom = 'none';
                        filledWordsInText[wordToInsert] = true; // Marca come correttamente riempito
                        this.classList.add('used'); // Marca la parola nella tabella come usata
                        playSound('successSound');
                    } else if (targetPlaceholder && filledWordsInText[wordToInsert]) {
                        // Già decifrato
                        playSound('clickSound'); // Suono neutro
                        alert('Questa parola è già stata inserita correttamente!');
                    } else {
                        // La parola cliccata non corrisponde a nessun placeholder vuoto, o è un distrattore
                        playSound('clickSound'); // Suono di errore
                        alert('Questa parola non corrisponde a un campo vuoto nel testo o è sbagliata per la posizione.');
                    }
                    
                    checkSymbolCompletion();
                });
            });
            
            function checkSymbolCompletion() {
                // Controlla se tutte le parole giuste sono state inserite
                const allWordsFilledCorrectly = Object.values(filledWordsInText).every(status => status === true);
                
                if(allWordsFilledCorrectly) {
                    document.getElementById('success4').style.display = 'block';
                }
            }
        }
        
        // Quiz (Stanza 5)
        function setupQuiz() {
            const quizLetters = document.getElementById('quizLetters');
            const correctWord = 'EDUCAZIONE CIVICA';
            const correctLetters = correctWord.split(''); // Split into array of chars
            let revealedLetters = Array(correctLetters.length).fill('_');
            
            const quizQuestions = document.querySelectorAll('#modal5 .quiz-question');
            let correctAnswersCount = 0;

            // Reset quiz for replayability (if modal closed and reopened)
            quizQuestions.forEach(question => {
                question.dataset.answeredCorrectly = 'false';
                question.querySelectorAll('input[type="radio"]').forEach(input => {
                    input.checked = false; // Uncheck all radio buttons
                });
            });
            revealedLetters = Array(correctLetters.length).fill('_');
            correctAnswersCount = 0;
            
            // Inizializza visualizzazione
            updateQuizLetters();

            quizQuestions.forEach(question => {
                const inputs = question.querySelectorAll('input[type="radio"]');
                inputs.forEach(input => {
                    input.addEventListener('change', function() {
                        const questionId = this.name;
                        const wasCorrectlyAnswered = question.dataset.answeredCorrectly === 'true';

                        if(this.dataset.correct !== undefined) {
                            if (!wasCorrectlyAnswered) { // Incrementa solo se è una nuova risposta corretta per questa domanda
                                correctAnswersCount++;
                                question.dataset.answeredCorrectly = 'true';
                                playSound('successSound');
                                revealRandomLetters(); // Rivela lettere solo per risposte corrette
                            }
                        } else {
                            if (wasCorrectlyAnswered) { // Se era corretta ma ora è sbagliata
                                correctAnswersCount--;
                                question.dataset.answeredCorrectly = 'false';
                            }
                            playSound('clickSound'); // Suono di errore per risposta sbagliata
                        }

                        updateQuizLetters();
                            
                        if(correctAnswersCount === quizQuestions.length) {
                            // Rivela tutte le lettere una volta completato il quiz
                            revealedLetters = [...correctLetters];
                            updateQuizLetters();
                            document.getElementById('success5').style.display = 'block';
                        }
                    });
                });
            });

            function revealRandomLetters() {
                let hiddenIndices = [];
                for(let i = 0; i < revealedLetters.length; i++) {
                    if(revealedLetters[i] === '_') {
                        hiddenIndices.push(i);
                    }
                }
                
                const lettersToReveal = Math.min(2, hiddenIndices.length); // Rivela max 2 nuove lettere per volta
                
                for(let i = 0; i < lettersToReveal; i++) {
                    if(hiddenIndices.length > 0) {
                        const randomIndex = Math.floor(Math.random() * hiddenIndices.length);
                        const letterIndex = hiddenIndices[randomIndex];
                        revealedLetters[letterIndex] = correctLetters[letterIndex];
                        hiddenIndices.splice(randomIndex, 1); // Rimuovi l'indice per non ripeterlo
                    }
                }
            }
            
            function updateQuizLetters() {
                // Filtra i caratteri '_' consecutivi per gli spazi
                let displayString = '';
                for (let i = 0; i < correctLetters.length; i++) {
                    if (correctLetters[i] === ' ') {
                        displayString += '&nbsp;&nbsp;'; // Usa spazi non-breaking per mantenere lo spazio
                    } else if (revealedLetters[i] === '_') {
                        displayString += '_ '; // Aggiungi underscore e uno spazio dopo
                    } else {
                        displayString += revealedLetters[i] + ' ';
                    }
                }
                quizLetters.innerHTML = displayString.trim(); // Usa innerHTML per &nbsp;
            }
        }
        
        // Funzioni di utilità
        function shuffleArray(array) {
            for(let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function playSound(soundId) {
            if(!soundEnabled) return;
            
            const sound = document.getElementById(soundId);
            sound.currentTime = 0; // Resetta il suono per riprodurlo subito
            sound.play().catch(e => console.log(`Impossibile riprodurre il suono ${soundId}:`, e));
        }
        
        // Toggle suono
        document.getElementById('soundToggle').addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? '🔊' : '🔇';
            
            const bgMusic = document.getElementById('backgroundMusic');
            if(soundEnabled) {
                bgMusic.play().catch(e => console.log("Autoplay della musica di sottofondo bloccato:", e));
            } else {
                bgMusic.pause();
            }
            playSound('clickSound'); // Un click per il toggle stesso
        });
    </script>
</body>
</html>